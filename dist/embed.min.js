!function(){"use strict"
function e(){}function t(e){return e}function n(e){return"string"==typeof e}function o(e){return null!==e&&"object"===("undefined"==typeof e?"undefined":y(e))}function r(e){return"function"==typeof e}function i(e){return e=C(e),0===e.length?e:e[0].toUpperCase()+e.slice(1)}function a(e){return null===e||void 0===e?"":C(e)}function s(){for(var e=/^\/+|\/+$/g,n=arguments.length,o=Array(n),r=0;r<n;r++)o[r]=arguments[r]
return o.map(function(t){return a(t).replace(e,"")}).filter(t).join("/")}function u(e){return Object.keys(e).filter(function(t){return e[t]}).map(function(t){return t+"="+encodeURIComponent(e[t])}).join("&")}function c(e,t){var n=e.indexOf(t),o=n>=0
return o&&e.splice(n,1),o}function d(e){var t=e
if(r(e))t=void 0
else if(_(e))t=e.map(d)
else if(o(e)){t={}
var n=Object.keys(e)
n.length||(n=Object.getOwnPropertyNames(e)),n.forEach(function(n){t[n]=d(e[n])})}return t}function l(e,t){var n=void 0
try{var o=window.localStorage[e]
n=JSON.parse(o||"{}")}catch(r){}return t?(n||{})[t]:n||{}}function f(e,t,n){var o=l(e)
o[t]=n
try{window.localStorage[e]=JSON.stringify(o)}catch(r){Z&&console.error("[QualifiedEmbed] Error saving editor data",r)}}function h(e){"complete"===te.readyState||"interactive"===te.readyState?window.setTimeout(e,1):te.addEventListener("DOMContentLoaded",e)}function v(e){if(e.$$destroyed)throw new Error("This manager has been destroyed, please create a new one")}function p(e){return btoa(e.replace(/.{2}/g,function(e){return String.fromCharCode(parseInt(e,16))})).replace(/[\/=+]/g,function(e){return oe[e]})}var m,y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},g=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},w=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n]
o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),b=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},E=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t)
e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},k=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called")
return!t||"object"!=typeof t&&"function"!=typeof t?e:t},I=function(){function e(e,t){var n=[],o=!0,r=!1,i=void 0
try{for(var a,s=e[Symbol.iterator]();!(o=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);o=!0);}catch(u){r=!0,i=u}finally{try{!o&&s["return"]&&s["return"]()}finally{if(r)throw i}}return n}return function(t,n){if(Array.isArray(t))return t
if(Symbol.iterator in Object(t))return e(t,n)
throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_=Array.isArray,C=String,O=function(){var e=[],t=!1
return{destroy:function(n){t=!0,e.forEach(function(e){e(n)})},onDestroy:function(n){t?n():e.push(n)}}},S={"http:":"80","https:":"443"},R=/^(https?:)?\/\/([^\/:]+)?(:(\d+))?/,j=["file:","data:"],P=function(e){if(e&&j.find(function(t){return e.startsWith(t)}))return"null"
var t=document.location,n=R.exec(e),o=void 0,r=void 0,i=void 0
n?(o=n[1]?n[1]:t.protocol,r=n[2],i=n[4]):(o=t.protocol,r=t.hostname,i=t.port)
var a=i&&i!==S[o]?":"+i:""
return o+"//"+r+a},$=function(e){return function(){for(var t=arguments.length,n=Array(t),o=0;o<t;o++)n[o]=arguments[o]
if(e){var r;(r=console).log.apply(r,["[Penpal]"].concat(n))}}}
!function(e){e.Call="call",e.Reply="reply",e.Syn="syn",e.SynAck="synAck",e.Ack="ack"}(m||(m={}))
var A
!function(e){e.Fulfilled="fulfilled",e.Rejected="rejected"}(A||(A={}))
var N
!function(e){e.ConnectionDestroyed="ConnectionDestroyed",e.ConnectionTimeout="ConnectionTimeout",e.NotInIframe="NotInIframe",e.NoIframeSrc="NoIframeSrc"}(N||(N={}))
var M
!function(e){e.DataCloneError="DataCloneError"}(M||(M={}))
var D
!function(e){e.Message="message"}(D||(D={}))
var T=function(e,t,n,o){return function(r){if(r.origin!==n)return void e("Parent: Handshake - Received SYN message from origin "+r.origin+" which did not match expected origin "+n)
e("Parent: Handshake - Received SYN, responding with SYN-ACK")
var i={penpal:m.SynAck,methodNames:Object.keys(t)}
r.source.postMessage(i,o)}},F=function(e){var t=e.name,n=e.message,o=e.stack
return{name:t,message:n,stack:o}},L=function(e){var t=new Error
return Object.keys(e).forEach(function(n){return t[n]=e[n]}),t},U=function(e,t,n){var o=e.localName,r=e.local,i=e.remote,a=e.originForSending,s=e.originForReceiving,u=!1,c=function(e){if(e.source===i&&e.data.penpal===m.Call){if(e.origin!==s)return void n(o+" received message from origin "+e.origin+" which did not match expected origin "+s)
var r=e.data,c=r.methodName,d=r.args,l=r.id
n(o+": Received "+c+"() call")
var f=function(e){return function(t){if(n(o+": Sending "+c+"() reply"),u)return void n(o+": Unable to send "+c+"() reply due to destroyed connection")
var r={penpal:m.Reply,id:l,resolution:e,returnValue:t}
e===A.Rejected&&t instanceof Error&&(r.returnValue=F(t),r.returnValueIsError=!0)
try{i.postMessage(r,a)}catch(s){if(s.name===M.DataCloneError){var d={penpal:m.Reply,id:l,resolution:A.Rejected,returnValue:F(s),returnValueIsError:!0}
i.postMessage(d,a)}throw s}}}
new Promise(function(e){return e(t[c].apply(t,d))}).then(f(A.Fulfilled),f(A.Rejected))}}
return r.addEventListener(D.Message,c),function(){u=!0,r.removeEventListener(D.Message,c)}},x=0,Q=function(){return++x},V=function(e,t,n,o,r){var i=t.localName,a=t.local,s=t.remote,u=t.originForSending,c=t.originForReceiving,d=!1
r(i+": Connecting call sender")
var l=function(e){return function(){for(var t=arguments.length,n=Array(t),l=0;l<t;l++)n[l]=arguments[l]
r(i+": Sending "+e+"() call")
var f=void 0
try{s.closed&&(f=!0)}catch(h){f=!0}if(f&&o(),d){var v=new Error("Unable to send "+e+"() call due to destroyed connection")
throw v.code=N.ConnectionDestroyed,v}return new Promise(function(t,o){var d=Q(),l=function h(n){if(n.source===s&&n.data.penpal===m.Reply&&n.data.id===d){if(n.origin!==c)return void r(i+" received message from origin "+n.origin+" which did not match expected origin "+c)
var u=n.data
r(i+": Received "+e+"() reply"),a.removeEventListener(D.Message,h)
var l=u.returnValue
u.returnValueIsError&&(l=L(l)),(u.resolution===A.Fulfilled?t:o)(l)}}
a.addEventListener(D.Message,l)
var f={penpal:m.Call,id:d,methodName:e,args:n}
s.postMessage(f,u)})}}
return n.reduce(function(e,t){return e[t]=l(t),e},e),function(){d=!0}},q=function(e,t,n,o,r){var i=o.destroy,a=o.onDestroy,s=void 0,u=void 0,c={}
return function(o){if(o.origin!==t)return void r("Parent: Handshake - Received ACK message from origin "+o.origin+" which did not match expected origin "+t)
r("Parent: Handshake - Received ACK")
var d={localName:"Parent",local:window,remote:o.source,originForSending:n,originForReceiving:t}
s&&s(),s=U(d,e,r),a(s),u&&u.forEach(function(e){delete c[e]}),u=o.data.methodNames
var l=V(c,d,u,i,r)
return a(l),c}},H=function(e){if(!e.src&&!e.srcdoc){var t=new Error("Iframe must have src or srcdoc property defined.")
throw t.code=N.NoIframeSrc,t}},K=6e4,Y=function(e,t){var n=t.destroy,o=t.onDestroy,r=setInterval(function(){document.contains(e)||(clearInterval(r),n())},K)
o(function(){clearInterval(r)})},J=function(e,t){var n=void 0
return void 0!==e&&(n=window.setTimeout(function(){var n=new Error("Connection timed out after "+e+"ms")
n.code=N.ConnectionTimeout,t(n)},e)),function(){clearTimeout(n)}},W=function(e){var t=e.iframe,n=e.methods,o=void 0===n?{}:n,r=e.childOrigin,i=e.timeout,a=e.debug,s=void 0!==a&&a,u=$(s),c=O(),d=c.onDestroy,l=c.destroy
r||(H(t),r=P(t.src))
var f="null"===r?"*":r,h=T(u,o,r,f),v=q(o,r,f,c,u),p=new Promise(function(e,n){var o=J(i,l),r=function(n){if(n.source===t.contentWindow&&n.data){if(n.data.penpal===m.Syn)return void h(n)
if(n.data.penpal===m.Ack){var r=v(n)
return void(r&&(o(),e(r)))}}}
window.addEventListener(D.Message,r),u("Parent: Awaiting handshake"),Y(t,c),d(function(e){window.removeEventListener(D.Message,r),e||(e=new Error("Connection destroyed"),e.code=N.ConnectionDestroyed),n(e)})})
return{promise:p,destroy:function(){l()}}},z=function(){function e(t){var n=t.node
if(g(this,e),!n)throw new Error("Cannot create an embedded editor without a node")
this.node=n
try{n.QualifiedEmbed=this}catch(o){}"IFRAME"===n.nodeName?this.iframe=n:(this.iframe=document.createElement("iframe"),n.appendChild(this.iframe)),this.iframe.classList.add("qualified-embedded")}return w(e,[{key:"destroy",value:function(){if(!this.$$destroyed){if(this.$$destroyed=!0,this.manager&&c(this.manager.editors,this),this.iframe&&(this.iframe.src="",this.iframe!==this.node&&this.iframe.parentNode&&this.iframe.parentNode.removeChild(this.iframe)),this.node)try{this.node.QualifiedEmbed=null}catch(e){}if(this.connection)try{this.connection.destroy()}catch(e){}this.iframe=this.node=this.manager=this.options=this.connection=this.childMethods=null}}},{key:"_initPenpal",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],o=this.manager,a={}
e.forEach(function(e){a[e]=function(a){var s,u="on"+i(e),c=(s={},b(s,t._type||"editor",t),b(s,"data",a),s)
n.forEach(function(e){c[e]=t[e]}),[t,t.options,o].forEach(function(e){e&&r(e[u])&&e[u](c)})}}),this.connection=W({iframe:this.iframe,timeout:3e5,methods:a}),this.connection.promise.then(function(e){t.childMethods=e})["catch"](function(e){t.$$destroyed||a.loaded({error:e?e.toString():"Unknown Connection Error",started:!1})})}},{key:"_post",value:function(e,t){return this.$$destroyed?Promise.reject(Error("Editor has been destroyed")):this.childMethods&&this.childMethods[e]?this.childMethods[e](d(t)):Promise.reject(Error('Unable to call method "'+e+'" on iframe'))}}]),e}(),B="[data-qualified-embed]",G="qualifiedEmbed",X="https://www.qualified.io",Z=!1,ee=function(e){function t(e){var n=e.node,o=e.challengeId,r=e.options,i=void 0===r?{}:r,a=e.manager
g(this,t)
var s=k(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,{manager:a,node:n}))
if(a){if(a.$$destroyed)throw new Error("Cannot create an embed on a destroyed manager object")
s.manager=a,a.editors.push(s)}if(o||(o=n.dataset[G]),!o)throw new Error("Unable to determine challenge ID from node: no value for data-qualified-embed")
return s.challengeId=o,s.options=Object.assign({},a&&a.options,a&&a.challengeOptions[o]||{},i),s._updateIframe(),s.challengeData={},s._initPenpal(["ready","loaded","change","runStart","run"],["challengeId","manager"]),s}return E(t,e),w(t,[{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.challengeId,n=void 0===t?this.challengeId:t,o=e.options,r=void 0===o?null:o,i=e.reload,a=void 0!==i&&i
this.$$destroyed||(r&&Object.assign(this.options,r),a||n&&this.challengeId!==n?(this.challengeId=n,this._updateIframe()):this._sendOptions())}},{key:"start",value:function(){return this._post("start")}},{key:"runTests",value:function(){return this._post("runTests")}},{key:"attempt",value:function(){return this._post("attempt")}},{key:"reset",value:function(){return this._post("reset")}},{key:"reload",value:function(){this._updateIframe()}},{key:"setFileContents",value:function(e,t){return this._post("setFileContents",{files:e,cursor:t})}},{key:"setRunResult",value:function(e){return this._post("setRunResult",e)}},{key:"onReady",value:function(){if(this.options.localStorageId){var e=l(this.options.localStorageId,this.challengeId)
e&&e.files&&(this.options.initialFiles=Object.assign({},this.options.initialFiles,e.files),e.cursor&&(this.options.initialCursor=e.cursor))}this._sendOptions()}},{key:"onLoaded",value:function(e){var t=e.data
this.challengeData=t}},{key:"onChange",value:function(e){var t=e.data
this.options.localStorageId&&f(this.options.localStorageId,this.challengeId,t)}},{key:"_sendOptions",value:function(){this._post("setOptions",this.options)}},{key:"_updateIframe",value:function(){if(!this.$$destroyed){var e={hasAuthToken:!!this.options.authToken,theme:this.options.theme},t=this.options.baseURL||X
this.iframe.src=s(t,"embed",this.challengeId)+"?"+u(e)}}}]),t}(z),te=window.document,ne=function(){function t(){var o=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=r.onLoaded,a=void 0===i?e:i,s=r.onRun,u=void 0===s?e:s,c=r.onRunStart,d=void 0===c?e:c,l=r.onChange,f=void 0===l?e:l,v=r.autoCreate,p=void 0!==v&&v,m=r.options,y=void 0===m?{}:m,w=r.challengeOptions,b=void 0===w?{}:w
g(this,t),this.onLoaded=a,this.onRun=u,this.onRunStart=d,this.onChange=f,this.editors=[],this.options=y,this.challengeOptions=b,p&&h(function(){var e=n(p)?p:B
Array.from(document.querySelectorAll(e)).forEach(function(e){o.createEditor({node:e})})})}return w(t,null,[{key:"init",value:function(e){return new t(e)}}]),w(t,[{key:"findEditor",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.node,n=e.challengeId
return v(this),t&&this.editors.find(function(e){return e.node===t})||n&&this.editors.find(function(e){return e.challengeId===n})||!1}},{key:"createEditor",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.node,n=e.challengeId,o=void 0===n?null:n,r=e.options,i=void 0===r?{}:r
v(this)
var a=this.updateEditor({node:t,challengeId:o,options:i})
return a||new ee({manager:this,node:t,challengeId:o,options:i})}},{key:"updateEditor",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.node,n=e.challengeId,o=void 0===n?null:n,r=e.options,i=void 0===r?{}:r
v(this)
var a=this.findEditor({node:t,challengeId:o})
return a&&a.update({challengeId:o,options:i}),a||!1}},{key:"destroy",value:function(){this.$$destroyed||(this.$$destroyed=!0,this.editors.forEach(function(e){e.destroy()}),this.editors=null)}}]),t}(),oe={"/":"_","+":"-","=":"~"},re=(Object.entries(oe).reduce(function(e,t){var n=I(t,2),o=n[0],r=n[1]
return e[r]=o,e},{}),function(e){function t(e){var n=e.node,o=e.options
g(this,t)
var r=k(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,{node:n}))
if(!o||!o.invitePath||!o.authToken)throw new Error("Unable to load an assessment without invitePath and authToken")
return r._type="assessment",r.options=Object.assign({},o),r._updateIframe(),r.assessmentData={},r._initPenpal(["ready","error","loaded","updated","solutionUpdated","submitted"]),r}return E(t,e),w(t,[{key:"next",value:function(){return this._post("next")}},{key:"previous",value:function(){return this._post("previous")}},{key:"welcome",value:function(){return this.switchChallenge("welcome")}},{key:"review",value:function(){return this.switchChallenge("review")}},{key:"submit",value:function(){return this._post("submit")}},{key:"switchChallenge",value:function(e){return this._post("switchChallenge",e)}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.options,n=void 0===t?null:t,o=e.reload,r=void 0!==o&&o
if(!this.$$destroyed){var i=!1
n&&(i=n.invitePath&&n.invitePath!==this.options.invitePath,Object.assign(this.options,n)),r||i?this._updateIframe():this._sendOptions()}}},{key:"reload",value:function(){this._updateIframe()}},{key:"onReady",value:function(){this._sendOptions()}},{key:"onLoaded",value:function(e){var t=e.data
this.assessmentData=t}},{key:"_sendOptions",value:function(){this._post("setOptions",this.options)}},{key:"_updateIframe",value:function(){if(!this.$$destroyed){var e=this.options.baseURL||X,t=this.options.invitePath.replace(/^(\/assess\/)([a-fA-F0-9]{24})/,function(e,t,n){var o="QE"+p(n)
return""+t+o})
this.iframe.src=s(e,t)}}}]),t}(z))
window.QualifiedEmbed=ne,window.QualifiedEmbeddedChallenge=ee,window.QualifiedEmbeddedAssessment=re}()
